dnf install -y kernel-devel sg3_utils device-mapper-multipath iscsi-initiator-utils &
ctr -n k8s.io images pull docker.io/$(curl -sk "https://install.portworx.com/$px_version?comp=pxoperator&kbver=$k8s_version" | awk '/image:/{print$2}') &
ctr -n k8s.io images pull docker.io/portworx/px-enterprise:$px_version &
ctr -n k8s.io images pull docker.io/portworx/oci-monitor:$px_version &
while : ; do
  command=$(ssh -oConnectTimeout=1 -oStrictHostKeyChecking=no master-$cluster kubeadm token create --print-join-command)
  echo $command | grep -qE '[0-9a-f]{64}'
  [ $? -eq 0 ] && break
  sleep 5
done
echo "Executing '$command'"
eval $command
wait
# set role for this node
ssh -oConnectTimeout=1 -oStrictHostKeyChecking=no master-$cluster kubectl label node $(hostname) node-role.kubernetes.io/worker=worker

# set providerID on AWS (needed for AWS ELB controller)
if [ $cloud = aws ] && [ $platform != eks ] && [ $platform != ocp4 ]; then
    IMDSTOKEN=$(curl -s -X PUT 'http://169.254.169.254/latest/api/token' -H 'X-aws-ec2-metadata-token-ttl-seconds: 120')
    instance_id=$(curl -H "X-aws-ec2-metadata-token: $IMDSTOKEN" -s http://169.254.169.254/latest/meta-data/instance-id)
    PATCH="{\"spec\":{\"providerID\": \"$instance_id\"}}"
    ssh -oConnectTimeout=1 -oStrictHostKeyChecking=no master-$cluster kubectl patch node $(hostname) -p \'$PATCH\'
fi
