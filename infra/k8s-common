# Add Kubernetes repo
repo=$(echo $k8s_version | cut -f 1,2 -d .)
cat <<EOF >/etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v$repo/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v$repo/rpm/repodata/repomd.xml.key
EOF

# Install prerequisites
while ! dnf install -y passt-selinux selinux-policy policycoreutils-python-utils selinux-policy-targeted container-selinux --setopt=tsflags=noscripts; do sleep 1; done
while ! dnf install -y kubelet-$k8s_version docker containerd kubeadm-$k8s_version kubectl-$k8s_version; do sleep 1; done

# setup containerd
containerd config default | sed 's/SystemdCgroup = false/SystemdCgroup = true/' | sed 's/device_ownership_from_security_context = false/device_ownership_from_security_context = true/' >/etc/containerd/config.toml
touch /etc/containers/nodocker
sed -i 's/^unqualified-search-registries.*$/unqualified-search-registries = ["docker.io"]/' /etc/containers/registries.conf

# Enable everything
systemctl daemon-reload
systemctl enable --now containerd podman kubelet

# Prepull Kubernetes images
kubeadm config images list --kubernetes-version $k8s_version | xargs -n1 -P0 ctr -n k8s.io images pull
