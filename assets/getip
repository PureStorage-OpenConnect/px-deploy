check_ip() {
  echo $1 | egrep -q '^[\.0-9]+$'
}

for i in $(seq 1 5); do
  pod=$(kubectl get pod -n portworx -l name=portworx -o jsonpath="{.items[0].metadata.name}")
  ip=$(kubectl exec $pod -n portworx -- curl -s https://ipinfo.io/ip)
  if ! check_ip $ip; then
    ip=$(kubectl exec $pod -n portworx -- curl -s https://ifconfig.me)
    if ! check_ip $ip; then
      continue
    fi
  fi
  echo $ip
  exit 0
done

echo "Cannot get IP" >&2
exit 1
